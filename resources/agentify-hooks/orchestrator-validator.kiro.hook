{
  "enabled": true,
  "name": "Orchestrator Validator",
  "description": "Validates main.py follows pre-bundled orchestrator architecture for all patterns including memory initialization",
  "version": "6",
  "when": {
    "type": "fileEdited",
    "patterns": ["agents/main.py"]
  },
  "then": {
    "type": "askAgent",
    "prompt": "Check agents/main.py follows the PRE-BUNDLED orchestrator architecture.\n\nFIRST: Determine the orchestration pattern from the docstring:\n- 'Graph Pattern' → validate Graph functions\n- 'Swarm Pattern' → validate Swarm functions\n- 'Workflow Pattern' → validate Workflow functions\n\nCRITICAL: The orchestrator is PRE-BUNDLED by Agentify. CLI parsing, event emission, and SDK calls are in agents/shared/orchestrator_utils.py.\n\nVERIFY IMPORTS from orchestrator_utils (DO NOT duplicate):\n- parse_arguments, validate_arguments\n- setup_environment, generate_session_id\n- get_timestamp, emit_event\n- invoke_agent_remotely\n- emit_workflow_error, print_workflow_summary, print_workflow_error_summary\n\nVERIFY CROSS-AGENT MEMORY INITIALIZATION:\n- Import: `from agents.shared import init_memory`\n- Call: `init_memory(session_id)` BEFORE first agent invocation\n- Placed in 'DO NOT MODIFY' section after session_id is generated\n- Memory initialization is fire-and-forget (returns bool, never raises)\n\n## Graph Pattern - CUSTOMIZATION SECTION Functions:\n- define_graph_structure() -> Dict with nodes and edges\n- get_entry_agent() -> str (first agent ID)\n- route_to_next_agent(current_agent, response) -> Optional[str]\n- get_agent_display_name(agent_id) -> str\n\n**route_to_next_agent() routing strategies (in priority order):**\n- Strategy 0: Haiku routing (OPTIONAL - handled by orchestrator_utils.py if useHaikuRouter: true in config)\n- Strategy 1: Check response.get('route_to') for explicit routing\n- Strategy 2: Check response.get('classification') with CLASSIFICATION_ROUTES dict\n- Strategy 3: STATIC_ROUTES dict for linear/predetermined routing\n- DO NOT use keyword matching on unstructured response text\n- DO NOT implement Haiku routing logic - it's pre-bundled in orchestrator_utils.py\n\n## Swarm Pattern - CUSTOMIZATION SECTION Functions:\n- define_graph_structure() -> Dict with nodes and possible handoff edges\n- get_entry_agent() -> str (first agent ID, usually coordinator)\n- get_agent_display_name(agent_id) -> str\n\nNOTE: Swarm does NOT have route_to_next_agent() - handoffs extracted by extract_handoff_from_response()\nNOTE: Haiku fallback is OPTIONAL safety net (if useHaikuRouter: true) - handled by orchestrator_utils.py, not implemented here\n\n## Workflow Pattern - CUSTOMIZATION SECTION Functions:\n- define_graph_structure() -> Dict with nodes and dependency edges\n- define_task_dag() -> Dict[str, List[str]] task dependencies\n- get_agent_display_name(agent_id) -> str\n- build_task_prompt(task_id, original_prompt, dependency_results) -> str\n\nNOTE: Workflow does NOT have get_entry_agent() or route_to_next_agent() - DAG determines order\n\n## DO NOT:\n- Add CLI argument parsing (it's in orchestrator_utils.py)\n- Add event emission functions (they're in orchestrator_utils.py)\n- Modify the main() function or GENERIC INFRASTRUCTURE section\n- Duplicate any functionality from orchestrator_utils.py\n- Use keyword matching (Graph pattern) - use CLASSIFICATION_ROUTES/STATIC_ROUTES instead\n- Implement Haiku routing logic - it's pre-bundled in orchestrator_utils.py\n- Define init_memory locally - import from agents.shared\n\n## MEMORY INITIALIZATION PATTERN\n\nThe main() function MUST include memory initialization:\n\n```python\n# Cross-Agent Memory: Import memory initialization (DO NOT MODIFY)\nfrom agents.shared import init_memory\n\n# In main() after session_id = generate_session_id():\n# Cross-Agent Memory: Initialize memory for data sharing between agents\nif init_memory(session_id):\n    print(\"  Cross-Agent Memory: enabled\", file=sys.stderr)\nelse:\n    print(\"  Cross-Agent Memory: disabled (MEMORY_ID not configured)\", file=sys.stderr)\n```\n\nIf main.py has wrong functions for the pattern, duplicate code, keyword matching, or missing memory initialization, FIX it."
  },
  "shortName": "orchestrator"
}
