{
  "enabled": true,
  "name": "Agent Prompt Response Format Validator",
  "description": "Validates agent prompts include correct response format based on orchestration pattern",
  "version": "3",
  "when": {
    "type": "fileEdited",
    "patterns": ["agents/*/prompts.py"]
  },
  "then": {
    "type": "askAgent",
    "prompt": "Check this agent's prompts.py for correct response format based on the orchestration pattern.\n\nFIRST: Determine the orchestration pattern by reading agents/main.py docstring:\n- 'Graph Pattern' → Graph orchestration\n- 'Swarm Pattern' → Swarm orchestration\n- 'Workflow Pattern' → Workflow orchestration\n\nTHEN: Validate the SYSTEM_PROMPT based on pattern:\n\n## Graph Pattern Requirements\n\nIf agents/main.py uses CLASSIFICATION_ROUTES or STATIC_ROUTES:\n\n**For agents with routing decisions (non-terminal agents):**\nSystem prompt MUST instruct agent to return structured JSON.\n\nFor Classification routing:\n```\nReturn your response as JSON:\n{\n  \"classification\": \"<category>\",\n  \"response\": \"Your response text\"\n}\n```\n\nFor Explicit routing:\n```\nReturn your response as JSON:\n{\n  \"route_to\": \"<next_agent_id>\" | null,\n  \"response\": \"Your response text\"\n}\n```\n\n**Check for keyword matching anti-pattern:**\nIf main.py route_to_next_agent() uses keyword matching like `if 'billing' in response_text`, this is WRONG.\nThe routing should use CLASSIFICATION_ROUTES or STATIC_ROUTES dicts instead.\n\n## Swarm Pattern Requirements\n\nSystem prompt MUST either:\n1. Instruct agent to use handoff_to_agent tool when handing off, OR\n2. Instruct agent to return JSON with handoff_to field\n\nExample instruction:\n```\nWhen you need another agent's help, use the handoff_to_agent tool.\nAvailable agents: [list agent IDs]\nIf your task is complete, respond normally without using the tool.\n```\n\n## Workflow Pattern Requirements\n\nNo routing fields required (DAG determines order).\nOptional: Structured JSON for better data flow between tasks.\n\n## Haiku Router Note\n\nIf useHaikuRouter: true in .agentify/config.json, the Haiku router will use guidance from the '## Routing Guidance' section in .kiro/steering/tech.md to make routing decisions.\n\nHowever, agent prompts STILL need response format instructions for fallback strategies (when Haiku routing fails or is disabled). The Haiku router is a supplement, not a replacement for proper agent response formatting.\n\n## Common Response Format Issues\n\n**Issue: Agent returning dict instead of string**\nIf agent tools return structured data (dicts), the agent might return the tool result directly instead of generating natural language.\n\nCheck for tools that return structured data (dicts) rather than plain strings and ensure the system prompt instructs the agent to:\n1. Use tool results to inform their response\n2. Always respond in natural language, not raw tool output\n3. Synthesize tool results into conversational responses\n\nAdd instruction like:\n```\nIMPORTANT: Always respond in natural language. When using tools that return structured data, use that information to craft your response but do not return the raw tool output directly.\n```\n\n**Issue: Validation errors in CloudWatch logs**\nCommon validation errors to prevent:\n- \"Agent response must be string, got dict\" \n- \"Response does not appear to contain structured analysis\"\n- Missing required fields in structured responses\n\n## Action\n\nIf the prompt is missing required response format instructions for the detected pattern, ADD them.\nIf the prompt could cause dict-instead-of-string issues, ADD natural language response instructions.\nDo not modify prompts that already have correct instructions."
  },
  "shortName": "agent-prompt"
}
