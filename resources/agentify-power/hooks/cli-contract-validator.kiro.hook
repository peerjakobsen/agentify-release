---
pattern: "agents/main.py"
trigger: fileSaved
description: Validates CLI contract for Agentify Demo Viewer integration
---

# CLI Contract Validator Hook

This hook validates that `agents/main.py` implements the CLI contract required by the Agentify Demo Viewer. The Demo Viewer spawns `main.py` as a subprocess with specific arguments and environment variables.

## WARNING Violations

All checks in this hook are WARNING level - they show in the problems panel but do not block file save.

### 1. Missing argparse Setup

**Check:** Verify argparse is imported and ArgumentParser is instantiated.

**Detection logic:**
1. Check for `import argparse` or `from argparse import`
2. Check for `ArgumentParser(` instantiation

**Warning message (if argparse import missing):**
```
WARNING: Missing argparse import in main.py.

The Demo Viewer passes arguments via command line. Add argparse:

  import argparse

  def parse_args():
      parser = argparse.ArgumentParser(description='Agentify Workflow')
      # Add arguments...
      return parser.parse_args()

See .kiro/steering/agentify-integration.md Section 1 for CLI contract details.
```

**Warning message (if ArgumentParser not found):**
```
WARNING: No ArgumentParser instantiation found in main.py.

The Demo Viewer passes --prompt, --workflow-id, and --trace-id arguments.
Add argument parsing:

  parser = argparse.ArgumentParser(description='Agentify Workflow')
  parser.add_argument('--prompt', required=True)
  parser.add_argument('--workflow-id', required=True)
  parser.add_argument('--trace-id', required=True)

See .kiro/steering/agentify-integration.md Section 1 for CLI contract details.
```

### 2. Missing Required CLI Arguments

**Check:** Verify all three required CLI arguments are defined.

**Required arguments:**
- `--prompt` - User prompt to process
- `--workflow-id` - Short workflow ID (format: wf-xxxxxxxx)
- `--trace-id` - OTEL trace ID for X-Ray correlation (32-char hex)

**Detection logic:**
1. Search for `add_argument` calls
2. Check for `'--prompt'` or `"--prompt"` in arguments
3. Check for `'--workflow-id'` or `"--workflow-id"` in arguments
4. Check for `'--trace-id'` or `"--trace-id"` in arguments

**Warning message (per missing argument):**
```
WARNING: Missing required CLI argument '{argument_name}'.

The Demo Viewer passes this argument when spawning main.py:

  parser.add_argument(
      '{argument_name}',
      required=True,
      help='{help_text}'
  )

Required arguments:
  --prompt       User prompt to process
  --workflow-id  Short workflow ID (wf-xxxxxxxx)
  --trace-id     OTEL trace ID (32-char hex)

See .kiro/steering/agentify-integration.md Section 1 for CLI contract details.
```

### 3. Missing Environment Variable Reads

**Check:** Verify required environment variables are read.

**Required environment variables:**
- `AGENTIFY_TABLE_NAME` - DynamoDB table name for persistent events
- `AGENTIFY_TABLE_REGION` or `AWS_REGION` - AWS region for DynamoDB table

**Detection logic:**
1. Search for `os.environ.get('AGENTIFY_TABLE_NAME')` or `os.environ['AGENTIFY_TABLE_NAME']`
2. Search for `os.environ.get('AGENTIFY_TABLE_REGION')` or `os.environ.get('AWS_REGION')` or bracket equivalents
3. Also check for `os.getenv(` variations

**Warning message (if AGENTIFY_TABLE_NAME missing):**
```
WARNING: Missing AGENTIFY_TABLE_NAME environment variable read.

The Demo Viewer sets this variable for DynamoDB event persistence.
Add environment variable handling:

  def validate_environment():
      table_name = os.environ.get('AGENTIFY_TABLE_NAME')
      if not table_name:
          raise EnvironmentError('Missing AGENTIFY_TABLE_NAME')
      return {'table_name': table_name}

See .kiro/steering/agentify-integration.md Section 1 for environment requirements.
```

**Warning message (if region variable missing):**
```
WARNING: Missing AWS region environment variable read.

The Demo Viewer sets AWS_REGION for DynamoDB operations.
Add environment variable handling:

  def validate_environment():
      region = os.environ.get('AWS_REGION', 'us-east-1')
      return {'region': region}

Accepted variables: AWS_REGION or AGENTIFY_TABLE_REGION

See .kiro/steering/agentify-integration.md Section 1 for environment requirements.
```

## Required CLI Contract

The complete CLI contract for `agents/main.py`:

```python
#!/usr/bin/env python3
import argparse
import os

def parse_args():
    parser = argparse.ArgumentParser(description='Agentify Workflow')
    parser.add_argument('--prompt', required=True, help='User prompt')
    parser.add_argument('--workflow-id', required=True, help='Workflow ID (wf-xxxxxxxx)')
    parser.add_argument('--trace-id', required=True, help='OTEL trace ID (32-char hex)')
    return parser.parse_args()

def validate_environment():
    required = ['AGENTIFY_TABLE_NAME', 'AWS_REGION']
    missing = [v for v in required if not os.environ.get(v)]
    if missing:
        raise EnvironmentError(f'Missing: {", ".join(missing)}')
    return {
        'table_name': os.environ['AGENTIFY_TABLE_NAME'],
        'region': os.environ['AWS_REGION']
    }

if __name__ == '__main__':
    args = parse_args()
    env = validate_environment()
    # Run workflow with args.prompt, args.workflow_id, args.trace_id
```

## Validation Rules Summary

| Rule | Severity | Pattern to Detect | Required Fix |
|------|----------|-------------------|--------------|
| Missing argparse | WARNING | No `import argparse` | Add argparse import |
| Missing ArgumentParser | WARNING | No `ArgumentParser(` | Add argument parser |
| Missing --prompt | WARNING | No `--prompt` argument | Add --prompt argument |
| Missing --workflow-id | WARNING | No `--workflow-id` argument | Add --workflow-id argument |
| Missing --trace-id | WARNING | No `--trace-id` argument | Add --trace-id argument |
| Missing TABLE_NAME | WARNING | No `AGENTIFY_TABLE_NAME` read | Add env var read |
| Missing AWS_REGION | WARNING | No `AWS_REGION` read | Add env var read |
