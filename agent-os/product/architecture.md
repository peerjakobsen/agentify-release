# Agentify Architecture

## System Overview

Agentify is a single Kiro IDE extension with two webview panels that share common services:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Agentify Extension                                   │
│                                                                              │
│  ┌──────────────────────┐          ┌──────────────────────┐                 │
│  │  Ideation Wizard     │          │    Demo Viewer       │                 │
│  │  Panel               │          │    Panel             │                 │
│  │                      │          │                      │                 │
│  │  - Account Context   │          │  - Workflow Input    │                 │
│  │  - AI Gap Filling    │          │  - Graph View        │                 │
│  │  - Agent Design      │          │  - Execution Log     │                 │
│  │  - Kiro Handoff      │          │  - Outcome Display   │                 │
│  └──────────┬───────────┘          └──────────┬───────────┘                 │
│             │                                  │                             │
│             └──────────────┬───────────────────┘                             │
│                            │                                                 │
│  ┌─────────────────────────┴─────────────────────────┐                      │
│  │              Shared Services                       │                      │
│  │                                                    │                      │
│  │  - AWS Clients (DynamoDB, Bedrock)                │                      │
│  │  - Configuration Service (.agentify/config.json)   │                      │
│  │  - Event Stream Service (stdout + DynamoDB merge)  │                      │
│  │  - Workflow Trigger Service (subprocess execution) │                      │
│  └────────────────────────────────────────────────────┘                      │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Deployment Model

**Single deployment model**: Orchestration always runs locally via `agents/main.py`, which calls agents deployed to Bedrock AgentCore via Strands SDK.

```
┌─────────────────┐     spawns      ┌─────────────────┐    Bedrock APIs    ┌─────────────────┐
│   Demo Viewer   │────────────────►│  agents/main.py │───────────────────►│   AgentCore     │
│   (VS Code)     │                 │  (local Python) │                    │   (AWS Cloud)   │
└─────────────────┘                 └─────────────────┘                    └─────────────────┘
        │                                   │                                      │
        │◄──────────────────────────────────┤ stdout events (real-time)           │
        │                                   │                                      │
        │                                   └──────────────────────────────────────┤
        │                                     DynamoDB events (tool calls)         │
        │                                                                          │
        └──────────────────────────────────────────────────────────────────────────┘
                              DynamoDB polling (500ms)
```

**Key points:**
- The local `main.py` is the orchestrator (generated by Kiro spec-driven development)
- Agents are deployed to AgentCore and invoked via Strands SDK / Bedrock APIs
- There is NO "AgentCore mode" vs "local mode" - it's always local orchestration calling cloud agents

## Extension Structure

```
agentify/
├── src/
│   ├── extension.ts              # Single activation point
│   ├── panels/
│   │   ├── ideationWizard/       # Wizard UI components
│   │   │   ├── IdeationWizardPanel.ts
│   │   │   └── webview/          # React app for wizard
│   │   └── demoViewer/           # Viewer UI components
│   │       ├── DemoViewerPanel.ts
│   │       └── webview/          # React app for viewer
│   ├── services/                 # Shared services
│   │   ├── awsClients.ts         # DynamoDB, Bedrock clients
│   │   ├── configService.ts      # .agentify/config.json reader
│   │   ├── eventStreamService.ts # Merged event stream
│   │   ├── workflowTrigger.ts    # Subprocess execution
│   │   └── dynamoDbPoller.ts     # DynamoDB event polling
│   └── shared/                   # Common utilities
│       ├── types.ts              # TypeScript interfaces
│       └── constants.ts          # Shared constants
├── infrastructure/
│   └── dynamodb-table.yaml       # CloudFormation template
└── package.json
```

## Event Flow Architecture

### Dual-Mode Event Streaming

Events come from two sources and are merged for the Demo Viewer:

```
┌─────────────┐    spawn    ┌─────────────┐   stream_async   ┌─────────────┐
│Demo Viewer  │────────────►│agents/      │─────────────────►│  stdout     │
│             │             │main.py      │                  │  (JSON)     │
└──────┬──────┘             └──────┬──────┘                  └──────┬──────┘
       │                           │                                │
       │                           │  StrandsTelemetry              │
       │                           │  (OTEL traces)                 │
       │                           ▼                                │
       │                    ┌─────────────┐                         │
       │  poll 500ms        │  DynamoDB   │                         │
       │◄───────────────────│  (events)   │                         │
       │                    └─────────────┘                         │
       │                                                            │
       │◄───────────────────────────────────────────────────────────┘
       │                    real-time stdout events
       ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    Merged Event Stream                               │
│                                                                      │
│  stdout events (real-time):     DynamoDB events (polled):           │
│  - graph_structure              - tool_call (start/complete)        │
│  - node_start                   - tool_result                       │
│  - node_stream                  - workflow_outcome                  │
│  - node_stop                                                        │
│  - workflow_complete                                                 │
└─────────────────────────────────────────────────────────────────────┘
```

**Event source characteristics:**
- **stdout streaming**: Real-time graph updates, low latency (~10ms)
- **DynamoDB polling**: Persistent tool call history, 500ms polling interval

## Hybrid Identity Model

Each workflow run has TWO identifiers for different purposes:

| Identifier | Format | Purpose |
|------------|--------|---------|
| `workflow_id` | `wf-{8-char-uuid}` | Short, human-readable. DynamoDB PK, UI display, stdout events |
| `trace_id` | 32-char hex (OTEL) | OpenTelemetry correlation. Links to CloudWatch X-Ray |

Both IDs are generated by the extension and passed to `main.py` via CLI:

```bash
python agents/main.py \
  --prompt "Generate Q3 replenishment plan" \
  --workflow-id "wf-abc12345" \
  --trace-id "80e1afed08e019fc1110464cfa66635c"
```

## Configuration Lifecycle

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Project Initialization                            │
│  Command: "Agentify: Initialize Project"                            │
│                                                                      │
│  1. Check AWS credentials (default provider chain)                  │
│  2. Check/Create DynamoDB table                                     │
│  3. Create .agentify/config.json (infrastructure section)           │
│  4. Create .kiro/steering/agentify-integration.md                   │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    Ideation Wizard                                   │
│                                                                      │
│  Reads:  .agentify/config.json                                      │
│  Writes: project.name, project.businessObjective, project.industry  │
│          project.systems, workflow.orchestrationPattern              │
│          Generates Kiro specs                                        │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    Kiro Implementation                               │
│                                                                      │
│  Reads:  .kiro/steering/agentify-integration.md                     │
│  Writes: agents/main.py (with observability patterns)               │
│          workflow.entryScript path in config.json                   │
│          workflow.agents, workflow.edges                             │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    Demo Viewer                                       │
│                                                                      │
│  Reads:  .agentify/config.json (entire file)                        │
│          - infrastructure.dynamodb for event polling                │
│          - workflow.entryScript for subprocess execution            │
│          - workflow.agents/edges for graph layout                   │
│  Writes: Nothing (read-only)                                         │
└─────────────────────────────────────────────────────────────────────┘
```

## Integration Points

### Extension ↔ Python Subprocess

```
Demo Viewer                          Python Subprocess
     │                                      │
     │  spawn with args:                    │
     │  --prompt "user input"               │
     │  --workflow-id "wf-abc12345"         │
     │  --trace-id "80e1afed..."            │
     ├─────────────────────────────────────►│
     │                                      │
     │  env vars:                           │
     │  AGENTIFY_TABLE_NAME                 │
     │  AGENTIFY_TABLE_REGION               │
     │                                      │
     │  stdout: JSON events (line by line)  │
     │◄─────────────────────────────────────┤
     │                                      │
     │  exit code: 0 success, 1 failure     │
     │◄─────────────────────────────────────┤
```

### Python ↔ DynamoDB

```
Python Agent                         DynamoDB
     │                                      │
     │  Event: workflow_id, trace_id, ...   │
     ├─────────────────────────────────────►│
     │                                      │
     │  tool_call events                    │
     ├─────────────────────────────────────►│
     │                                      │
     │  workflow_complete/error             │
     ├─────────────────────────────────────►│
```

## DynamoDB Event Schema

| Attribute | Type | Description |
|-----------|------|-------------|
| `workflow_id` | String (PK) | Short workflow ID (wf-{8-char-uuid}) |
| `timestamp` | Number (SK) | Epoch milliseconds |
| `trace_id` | String | OTEL trace ID for X-Ray correlation |
| `event_type` | String | `node_start`, `node_stop`, `tool_call`, `workflow_complete`, etc. |
| `agent_name` | String | Name of the agent that emitted the event |
| `payload` | Map | Event-specific data (JSON) |
| `ttl` | Number | Unix timestamp for automatic deletion (7 days) |

## stdout Event Types

Events emitted to stdout follow this schema:

| Event Type | Description | Mapped From |
|------------|-------------|-------------|
| `graph_structure` | Topology emitted at workflow start | N/A (first event) |
| `node_start` | Agent/node beginning execution | `multiagent_node_start` |
| `node_stream` | Streaming content from node | `multiagent_node_stream` |
| `node_stop` | Agent/node completed | `multiagent_node_stop` |
| `tool_call` | Tool invocation started | Tool execution |
| `tool_result` | Tool invocation completed | Tool execution |
| `workflow_complete` | Workflow finished successfully | `multiagent_result` |
| `workflow_error` | Workflow failed with error | Exception handling |

## Security Considerations

### Credential Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                    AWS Credential Chain                              │
│                                                                      │
│  Extension:                                                          │
│  1. Kiro AWS Explorer integration (if available)                    │
│  2. Environment variables (AWS_ACCESS_KEY_ID, etc.)                 │
│  3. AWS config files (~/.aws/credentials, ~/.aws/config)            │
│  4. IAM Identity Center (SSO)                                       │
│  5. IAM role (if running on AWS)                                    │
│                                                                      │
│  Python Subprocess:                                                  │
│  - Inherits credentials from extension environment                  │
│  - Uses boto3 default credential chain                              │
└─────────────────────────────────────────────────────────────────────┘
```

### Required IAM Permissions

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "dynamodb:DescribeTable",
        "dynamodb:PutItem",
        "dynamodb:Query"
      ],
      "Resource": "arn:aws:dynamodb:*:*:table/agentify-*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "bedrock:InvokeModel",
        "bedrock:InvokeModelWithResponseStream",
        "bedrock:InvokeAgent"
      ],
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "xray:PutTraceSegments",
        "xray:PutTelemetryRecords"
      ],
      "Resource": "*"
    }
  ]
}
```

## Performance Characteristics

| Operation | Target Latency | Notes |
|-----------|---------------|-------|
| UI Response | < 100ms | React rendering |
| stdout Event | < 10ms | Real-time streaming |
| DynamoDB Poll | < 500ms | Polling interval |
| Graph Update | < 1s | Node status changes |
| Bedrock Response | < 5s | Claude API calls |
